\documentclass{pnp_article}

\externaldocument{../pus/PusExtension}  % Allows cross-references to Def. Doc.
\externaldocument{../um/PusExtensionVR}   	% Allows cross-references to UM

\begin{document}

\SetDocIssue{0.2}
\SetDocRefNumber{PP-UM-PUX-0001}
\SetDocTitle{CORDET Framework - PUS Extension}
\SetDocSubtitle{Software User Manual}
\SetDocAuthor{Alessandro Pasetti}
\SetCheckedBy{n.a.}
\maketitle


\newpage
\tableofcontents
%\newpage
%\listoffigures
%\newpage
%\listoftables

%---------------------------------------------
% Import file with definition of commands and reports
%---------------------------------------------
\input{../pus/GeneratedTables/CrPsSpec.tex}


%==========================================================================================
\section{References}
The documents referenced in this document are listed in table \ref{tab:refdoc}.

\listofreferencedocs{\PxUm}

%==========================================================================================
\section{Introduction}
This document is the software user manual for the PUS Extension of the CORDET Framework. The PUS Extension of the CORDET Framework is aimed at on-board satellite applications. It provides an implementation of a subset of the PUS services defined in reference [PS-SP]. The currently supported services are listed in table TBD.

The PUS Extension of the CORDET Framework is built as an instantiation of the CORDET Framework of reference [CR-SP]. Readers of this user manual are expected to be familiar with the documentation of the CORDET Framework.

The PUS Extension of the CORDET Framework supports the development of  PUS-compliant on-board applications. Figure \ref{fig:PusExtensionAppOverview} illustrates the structure of such an application. The core of the application is the CORDET Framework which implements the management of in- and out-going commands and reports. The CORDET Framework has two main sets of interfaces:

\begin{itemize}
\item An interface towards the underlying middleware which carries raw commands and reports as byte packets. This interface is encapsulated in framework components \texttt{InStream} and \texttt{OutStream}. Each such component manages one command/report destination or source.
\item An interface towards the application to implement concrete commands and reports. Incoming commands are implemented in instances of framework component \texttt{InCommand} and out-going reports are implemented in instances of framwork component \texttt{OutComponent}. 
\end{itemize}

The CORDET Framework is built on an abstract model of commands and reports and therefore it is independent of the specific actions which a command executes or of the specific data which a report carries. The PUS Extension extends the CORDET Framework by providing concrete implementations for the commands and reports of the PUS services listed in table \ref{tab:servStatus}.

Reference [PX-SP] describes and specifies the PUS Extension. Its software has undergone an extensive qualification programme whose outcome is documented in reference [PX-VR]. A TM/TC ICD is available in reference [PX-IC] documenting the commanding and reporting interface used to test the PUS Extension.

This commanding and reporting was defined through the CORDET Editor. The CORDET Editor is a proprietary tool of P\&P Software GmbH to model PUS-based applications. The CORDET Editor includes a code-generating front-end which generates C-code to implement the data pool of a PUS application and the functions to access the parameters of its commands and reports. Part of the code in the Delivery File of the PUS Extension of the CORDET Framework was generated by the CORDET Editor. Users will normally have to replace this code with code implementing their own commanding and reporting interface.

The CORDET Framework is flight-proven having been used for the payload software of the CHEOPS satellite and of the SMILE satellite. Its PUS Extension is currently a beta version.

\pnpfigure[scale=0.5]{Overview of PUS Extension Application}{fig:PusExtensionAppOverview}{PusExtensionAppOverview.png}

\begin{pnptable}{|c|>{\raggedright\arraybackslash}p{5cm}|>{\raggedright\arraybackslash}p{5cm}|}{Service Development Status}{tab:servStatus}{\textbf{N} & \textbf{Service Name} & \textbf{Status}}
\texttt{1} & Request Verification Service & Supported in full \\
\hline
\texttt{3} & Housekeeping Service & Supported as per table \ref{tab:listOfCmdRep3} \\
\hline
\texttt{5} & Event Reporting Service & Supported in full \\
\hline
\texttt{11} & Time-Based Scheduling & Under development \\
\hline
\texttt{12} & On-Board Monitoring Service & Under development \\
\hline
\texttt{13} & Large Packet Transfer Service & Under development \\
\hline
\texttt{17} & Test Service & Supported in full \\
\hline
\end{pnptable}  

\newpage
\pnpcsvtable{|c|l|p{7cm}|}{List of Supported Commands/Reports for Service 1}{tab:listOfCmdRep1}{Type & CORDET Name & PUS Name}{../pus/GeneratedTables/PUSExtensionServiceOverview.csv}{\Type & \Name & \Description}

%------------------------------------------------------------------------------------------
\section{Installation \& Content Overview}\label{sec:InstAndContentOverview}
The PUS Extension of the CORDET Framework can be accessed in two forms:

\begin{itemize}
\item As one single zip file (the \emph{delivery file}) available from the project web site at \url{https://www.pnp-software.com/cordetfw/}
\item As a public GitHub project at: \url{https://github.com/pnp-software/cordetfw-pus}
\end{itemize}

The delivery file is entirely self-contained and includes a complete instantiation of the PUS Extension. The GitHub project, instead, does not contain the code generated from the CORDET Editor model of the PUS Extension. Users should therefore normally start from the Delivery File and this User Manual accordingly focuses on the Delivery File. 

The Delivery File should be expanded in a dedicated directory, which becomes the \emph{host directory} for the PUS Extension of the CORDET Framework.
Table \ref{tab:HostDir} gives an overview of the structure of the host directory.
More details are found in subsequent subsections.

The PUS Extension software is delivered as source code and therefore no further installation operations are needed. A Test Suite is provided together with Unix script files to compile and link it.

\begin{longtable}{|l|p{11cm}|}
\caption{Structure of Host Directory}\label{tab:HostDir} \\
\hline
\rowcolor{light-gray}
\textbf{Sub-Dir.} & \textbf{Sub-Directory Description}\\
\hline\hline
\texttt{/doc} & Support documentation. See section \ref{sec:SupportDoc}.\\
\hline
\texttt{/lib} & External libraries used by the PUS Extension. See section \ref{sec:depLib}.\\
\hline
\texttt{/log} & Test reports and log files. See section \ref{sec:atp}.\\
\hline
\texttt{/src} & Source code for the PUS Extension. See section \ref{sec:fwSrcCode}.\\
\hline
\texttt{/tests} & Source code for the Test Suite. See section \ref{sec:fwSrcCode}.\\
\hline
\end{longtable}

%--------------------------------------------------------------------------------------------
\subsection{Dependency on External Libraries}\label{sec:depLib}
The PUS Extension is built as an instantiation of the CORDET Framework. This is explained in sections 2 and 3 of reference [PX-SP].

The CORDET Framework (both its source code and its documentation) is included in the delivery file of the PUS Extension (in directory \texttt{lib}). 

The behaviour of some of the services supported by the PUS Extension is specified by means of state machines and procedures (activity diagrams). The implementation of the PUS Extension therefore requires an implementation of state machines and procedures. The PUS Extension does not include an own implementation of state machines and procedures. Instead, it uses the state machine and procedure modules of the FW Profile (see reference [FW-SP]). 

The FW Profile (both its source code and its documentation) is included in the delivery file of the PUS Extension (in directory \texttt{lib/cordetfw/lib}). 

Note that the FW Profile, the CORDET Framework and its PUS Extension are published under the same MPL licence. 

%--------------------------------------------------------------------------------------------
\subsection{Source Code}\label{sec:fwSrcCode}
The source code in the Delivery File covers one instantiation of the PUS Extension for the \textit{Test Suite} (see section \ref{sec:TestSuite}). 

At source code level, an instantiation of the PUS Extension of the CORDET Framework can be split into four parts:

\begin{itemize}
\item \textbf{Invariant Code} consisting of: (a) the implementation of the FW Profile, (b) the implementation of the CORDET Framework, and (c)  the implementation of the behaviour of the commands and reports supported by the PUS Extension. This code is common to all instantiations of the PUS Extension. 
\item \textbf{Configurable Code} consisting of the part of the code which must be modified to be adapted to the needs of each end-application (the adaptation model for the framework is described in section \ref{sec:AdaptationModel}). This part is customized for each instantiations of the PUS Extension. 
\item \textbf{Application-Specific Code} implementing the application-specific (i.e. non-framework) part of the target application. 
\end{itemize}

The Delivery File contains the invariant code and the configuration and application-specific code for the Test Suite Application. This is an application instantiated from the PUS Extension of the CORDET Framework for testing purposes (see section \ref{sec:TestSuite}).

The source code in the PUS file is split into several sub-directories as presented in table \ref{tab:srcCrDeliveryFile}. Users who wish to build a new application by instantiating the PUS Extension should take the invariant directories without changes and should customize the software in the remaing directories to match their needs. The instantiation process is described in section \ref{sec:FwInstantiation}.

\begin{pnptable}{|l|>{\raggedright\arraybackslash}p{10cm}|}{Sub-Directory}{tab:srcCrDeliveryFile}{\textbf{Sub-Directory} & \textbf{Sub-Directory Description}}
\texttt{/src/DataPool} & \textbf{Configurable Code}: Implementation of the data pool for the Test Suite Application. This code is generated by the CORDET Editor. \\
\hline
\texttt{/src/Dum} & \textbf{Application-Specific Code}: Implementation of the Dummy Service (a private service used by the Test Suite application). \\
\hline
\texttt{/src/Evt} & \textbf{Invariant Code}: Implementation of the Event Reporting Service.  \\
\hline
\texttt{/src/Hk} & \textbf{Invariant Code}: Implementation of the Housekeeping Service.  \\
\hline
\texttt{/src/Lpt} & \textbf{Invariant Code}: Implementation of the Large Packet Transfer Service. This code is untested and should not be used. \\
\hline
\texttt{/src/Mon} & \textbf{Invariant Code}: Implementation of the Monitoring Service. This code is untested and should not be used. \\
\hline
\texttt{/src/Pckt} & \textbf{Configurable Code}: Implementation of the functions to access parameters in the PUS packets. This code is generated by the CORDET Editor. \\
\hline
\texttt{/src/Scd} & \textbf{Invariant Code}: Implementation of the Scheduling Service. This code is untested and should not be used. \\
\hline
\texttt{/src/Tst} & \textbf{Invariant Code}: Implementation of the Test Service.  \\
\hline
\texttt{/src/Ver} & \textbf{Invariant Code}: Implementation of the Command Verification Service.  \\
\hline
\texttt{/lib} & \textbf{Invariant Code}: Source code for the CORDET Framework and FW Profile. This  code is used unchanged in all applications instantiated from the PUS Extension. \\
\hline
\texttt{/tests} & \textbf{Application-Specific Code}: Implementation of Test Suite application. \\
\hline
\texttt{/tests/PusConfig} & \textbf{Configurable Code}: Configuration code for the CORDET Framework. The header files \texttt{CrFwOutRegistryUserPar.h}, \texttt{CrFwOutFactoryUserPar.h} and \texttt{CrFwInFactoryUserPar.h} are generated by the CORDET Editor. \\
\hline
\end{pnptable}


%------------------------------------------------------------------------------------
\subsection{Support Documentation}\label{sec:SupportDoc}
The PUS Extension is delivered with the following support documents: 

\begin{itemize}
\item The \textbf{PUS Extension Definition Document} which specifies the PUS Extenstion
\item A \textbf{User Manual} (this document) which describes how the C2 Implementation is used
\item A \textbf{Verification Report} which provides validation and verification evidence for the PUS Extension of the CORDET Framework
\item A \textbf{TM/TC ICD} which defines the command and reporting interface used for the Test Suite application. All tables in this document are generated from the CORDET Editor.
\end{itemize}

These documents, together with the Test Suite and the detailed software documentation in the Doxygen web site, constitute the \textbf{Qualification Data Package} (QDP) for the PUS Extension. The QDP is provided for users who need to certify their application or, more generally, who need to provide evidence of its correctness. The QDP contains the typical information which is required for software certification purposes. It can therefore be included in the certification data package of end-applications and it relieves the user of the need to produce such information for the PUS Extension part of their applications.

%------------------------------------------------------------------------------------
\subsection{Doxygen Documentation}\label{sec:DoxygenDoc}
All the source code in the PUS Extension (including the test suite and the CORDET Framework code) is documented in accordance with doxygen rules. The entry point to the Doxygen documentation is the \texttt{index.html} file in the \texttt{/doc/doxygen} directory.

%------------------------------------------------------------------------------------
\subsection{Test Suite}\label{sec:TestSuite}
The Test Suite is a complete application which demonstrates all aspects of the behaviour of the PUS Extension of the CORDET Components.

The main program of the Test Suite application is in file \texttt{CrPsTestSuite.c}. This program consists of a set of test cases. For each supported service, one or more test cases are defined. Each test case exercises a specific aspect of the behaviour of a CORDET Component. The Test Suite aims to offer 100\% code, branch, and condition coverage of the CORDET Components. This target will be confirmed in release 1.0.0 of the PUS Extension.

On a Unix platform, the Test Suite application can be built by running one of the support scripts delivered with the PUS Extension (see section \ref{sec:script}). 

%----------------------------------------------------------------------------------------------
\subsection{Customization of Command and Reporting Interface}\label{sec:cmdRepIf}

The layout of the commands and reports supported by the instance of the PUS Extension in the Delivery File is defined in reference [PX-IC]. Users will normally need to adapt this layout to their needs by adapting:

\begin{itemize}
\item The values of the PUS Framework constants
\item The set of command verification failure codes
\item The set of event identifiers
\item The size of the types of the command and report parameters
\item The endianity of the command and report parameters
\end{itemize}

One convenient way to perform these adaptations is by editing the model of the PUS Extension in the CORDET Editor. The adaptations identified above are then done as follows.

\paragraph{Constants}
The values of the PUS Framework constants are defined in page "PUS Extension->Constants" of the CORDET Editor.

\paragraph{Command Verification Failure Codes}
These are defined through the definition of the enumerated type \texttt{CrPsFailCode\_t} in the "PUS Extension->Packets->Datatypes" page of the CORDET Editor.

\paragraph{Event Identifiers}
These are defined through the definition of the enumerated type \texttt{CrPsEvtId\_t} in the "PUS Extension->Packets->Datatypes" page of the CORDET Editor.

\paragraph{Endianity}
This is controlled through a flag set in the "Setting" menu of the "Packet Access Function Generator" in the "CrPs->Extensions" page of the editor. Additionally, adjustment of endianity requires adjustments in: (a) The packet accessor functions in \texttt{CrFwPckt.h} and (b) The \texttt{getDpValueEx} function.


%----------------------------------------------------------------------------------------------
\subsection{Generation of Delivery File}\label{sec:atp}
The Delivery File contains all the inputs required to generate both the software and the documentation for the PUS Extension of the CORDET Framework. Table \ref{tab:atp} describes the step-by-step procedure to generate a new version of the PUS Extension. Its starting point is the availability of a complete delivery. 


\begin{pnptable}{|l|>{\raggedright\arraybackslash}p{12.2cm}|}{Generation of a New PUS Extension Delivery}{tab:atp}{N & Step}
1 & Export the models from the FW Profile Editor through the "Download C Code Dynamic" action in the editor. This action returns one single zipped file holding the models in \texttt{json} format, the code generated from them, and the image files with the state machine and procedure diagrams. \\
\hline
2 & Run the following code generators in CORDET Editor: (a) ICD Generator, (b) Data Pool Generator, (c) Specification Generator, (d) Packet Access Function Generator, and (e) CordetFw Generator \\
\hline
3 & Run the \texttt{ImportGenProducts.sh} script to import the auto-generated items into the delivery directory. The instruction for running the script are in the comment at the beginning of the script. The items to be imported are: (a) code outputs generated by the CORDET Editor, (b) data pool csv description file generated by the CORDET Editor, (c) constants csv description file generated by the CORDET Editor, and (d) code generated by the FW Profile Editor. \\
\hline
4 & Update the framework documentation as needed. The library documentation is in latex format in the following directories: \texttt{doc/int/um} (user manual), \texttt{doc/int/pus} (specification), \texttt{doc/int/vr} (verification report), \texttt{doc/int/icd} (TM/TC ICD). \\
\hline
5 & Update the document issue numbers in file \texttt{doc/int/common/RefDoc.csv} and in the \texttt{MakeDeliveryFile.sh} script \\
\hline
6 & Run Doxygen on the entire source code of the delivery by running command: \texttt{doxywizard DoxygenConfig.txt} from the top-level directory of the framework. Verify that neither errors nor warnings are reported by doxygen. \\
\hline
7 & Delete all items generate in previous tests of the framework by running command: \texttt{make clean}.  \\
\hline
8 & Build the executable of the Test Suite with "all warnings" enabled by running command: \texttt{make test}. This step should be done twice with \texttt{gcc} and with \texttt{clang} (the compiler is selected by editing one line at the top of the \texttt{makefile}). Verify that neither errors nor warnings are reported by the compiler or linker. \\
\hline
9 & Run \texttt{scan-build} by again running command \texttt{make clean} and then running command \texttt{scan-build -o log make test}. Verify that all issues reported by \texttt{scan-build} are false positives. \\
\hline
10 & Run the Test Suite with command: \texttt{make run-test} and verify that all test cases are executed successfully. \\
\hline
11 & Run again the Test Suite with Valgrind through command: \texttt{make run-test-valgrind}. Verify that the Test Suite runs to completion and that no memory leaks are reported by Valgrind. \\
\hline
12 & Run \texttt{lcov} on all library source files through command: \texttt{make gen-lcov}. Verify coverage levels in the \texttt{lcov} output in directory \texttt{lcov}. See also section \ref{sec:svrCodeCov} of reference [TiVr]. \\
\hline
13 & Take a snapshot of the summary table of \texttt{lcov} and store it in file \texttt{doc/int/images/LcovCodeCovReport.png} from where it will be used for building the Verification Report. \\
\hline
14 & Compute the software metrics by running command \texttt{lizard -C 10 src}. Use the output of this command to fill in the table in section \ref{sec:svrSwMetrics} of reference [TiVr]. \\
\hline
15 & Generate the PDF version of the library documents by compiling the latex documents. Compilation must be run twice to ensure that all cross-references are correctly linked. Verify that compilation is successful. \\
\hline
16 & When all above steps have been successfully completed, generate the delivery data package by running script \texttt{MakeDeliveryFile.sh}. \\
\hline
\end{pnptable}

With reference to point 5, it is noted that, depending on the test timing, Valgrind may report 3 possible memory leaks originating in function \texttt{pthread\_create}. This is due to the fact that the test cases in module \texttt{CrFwSocketTestCase} create threads but do not join them before terminating. This potential leak does not affect the framework code and is therefore accepted.

%------------------------------------------------------------------------------------
\subsection{Support Scripts}\label{sec:script}
To build the Test Suite a Makefile is provided in the root directory. This Makefile can be used with the generally available \texttt{make} tool to generate different targets. The following targets are supported:

\begin{itemize}
\item \texttt{make test} Generates the test suite
\item \texttt{make run-test} Runs the test suite
\item \texttt{make run-test-valgrind} Runs the test suite
\item \texttt{make gen-lcov} Generates the gcov files which contain the coverage information
\item \texttt{make gen-lcov} Generates the \texttt{lcov} files which contain the coverage information in html format
\end{itemize}

The test suite is created in the \texttt{/bin} sub-directory.

Additionally, the following scripts are provided:

\begin{itemize}
\item \texttt{ImportGenProducts.sh} copies the files generated by the FW Profile and the CORDET Editor to the \texttt{cordetfw-pus} directory
\item \texttt{MakeDeliveryFile.sh} generates the delivery file
\end{itemize}

%------------------------------------------------------------------------------------
\subsection{Verification Environment}\label{sec:umVerEnviron}
The PUS Extension of the CORDET Framework has been developed and verified in the following enviroment (the first two items were obtained by entering \texttt{g++ -v} and \texttt{uname -a} at the terminal):

\begin{itemize}
\item Ubuntu 5.4.0-6ubuntu1~16.04.10 on an x86\_64 target
\item Linux ap 4.4.0-141-generic \#167-Ubuntu SMP Wed Dec 5 10:40:15 UTC 2018 x86\_64 x86\_64 x86\_64 GNU/Linux
\item Version 5.4.0 of \texttt{gcc}
\item Version 3.8.0-2ubuntu4 (tags/RELEASE\_380/final) of \texttt{clang} for x86\_64-pc-linux-gnu with posix thread model
\item Version 1.3.1 of the FW Profile
\item Version 1.14.10 of \texttt{lizard} (computation of software metrics)
\item Version 1.8.11 of \texttt{Doxygen}
\end{itemize}

The tool \texttt{scan-build} was used to perform a static check on the framework code. It does not seem to be possible to obtain the version of the installed tool.



%=========================================================================
\section{Mode of Use}
The PUS Extension of the CORDET Framework extends the CORDET Framework in the sense that: (a) it closes some of its adaptation points and (b) it adds some new adaptation points. Table \ref{tab:APTable} lists the CORDET Framework adaptation points which are closed by the PUS Extension and the adaptation points which are added by the PUS Extension.

The instantiation process for the PUS Framework extends the instantiation process of the CORDET Framework (see section 24 of the CORDET Framework User Manual in reference [CR-SP]) as follows:

TBD

%--------------------------------------------------------------------------------------------
\subsection{Memory Management}
The PUS Extension of the CORDET Framework allocates memory both on the stack and on the heap. Stack usage has not been measured but it is noted that no recursive function calls are made by the PUS Extension code\footnote{Recursion is used in the FW Profile Library but, in that case, the depth of recursion is the same as the depth of nesting of state machines (see the FW Profile User Manual in reference [FwProf]). Since no nested state machines are used in the PUS Extension, it can be assumed that no recursion is used.}.

Memory allocation from the heap is done exclusively during the initialization phase. There is therefore no risk of memory leaks. This has been verified both with the help of the \texttt{Valgrind} tool and through static code analysis (see section \ref{sec:svrMemMng} in reference [PX-VR]. 

%------------------------------------------------------------------------------------
\subsection{Real-Time Aspects}
The PUS Extension, like the CORDET Framework, is purely passive and does not create any own threads. The same considerations as for the real-time aspects of the CORDET Framework (see section 22 of the CORDET Framework User Manual in reference [CR-SP]) also apply to the PUS Extension.

%------------------------------------------------------------------------------------
\subsection{Operational Constraints}
The operational constraints are listed in the "Related Pages->Constraints" page of the doxygen documentation. Compliance with these constraints is mandatory and failure to comply with them will result in unpredictable (and probably undesirable) behaviour.


%------------------------------------------------------------------------------------
\subsection{Limitations}
Limitations (i.e. functionalities which are specified but not implemented) are listed in the "Related Pages->Limitations" page of the doxygen documentation.

%------------------------------------------------------------------------------------
\subsection{Known Bugs}
Bugs are tracked through the "Issues" facility of the \texttt{cordetfw-pus} project.


\begin{landscape}

\pnpcsvtable{|l|c|>{\raggedright\arraybackslash}p{5cm}|>{\raggedright\arraybackslash}p{5cm}|>{\raggedright\arraybackslash}p{6cm}|}{Adaptation Points Closed or Created by PUS Extension of CORDET Framework}{tab:APTable}{Req. ID & Origin & Description & Default Valut & Implementation }{../pus/PusExtensionAP.csv}{\Category-\Id & \Origin & \AP & \DefValue & \Implementation}

\end{landscape}


\end{document}